<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Claude Code</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#1e1e2e;--surface:#252536;--surface-hover:#2a2a3d;
  --border:#333346;--border-light:#3e3e56;
  --text:#cdd6f4;--text-bright:#fff;--muted:#6c7086;
  --accent:#c084fc;--accent-dim:rgba(192,132,252,.12);--accent-border:rgba(192,132,252,.25);
  --user-bg:#2a2a3d;--user-border:#3e3e56;
  --warning:#f9e2af;--warning-bg:rgba(249,226,175,.08);
  --danger:#f38ba8;--danger-bg:rgba(243,139,168,.08);
  --success:#a6e3a1;--success-bg:rgba(166,227,161,.08);
  --diff-add:rgba(166,227,161,.12);--diff-del:rgba(243,139,168,.12);
  --diff-add-text:#a6e3a1;--diff-del-text:#f38ba8;
  --font-sans:-apple-system,system-ui,'Segoe UI','Helvetica Neue',sans-serif;
  --font-mono:'SF Mono',Menlo,'Cascadia Code','JetBrains Mono',Consolas,monospace;
}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:var(--font-sans);font-size:14px;line-height:1.6}
body{display:flex;flex-direction:column;height:100dvh}
svg.ic{width:1em;height:1em;stroke:currentColor;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;fill:none;vertical-align:-.125em;flex-shrink:0}

/* ── ヘッダー ── */
.header{display:flex;align-items:center;gap:8px;padding:10px 16px;border-bottom:1px solid var(--border);background:var(--surface);flex-shrink:0}
.header-logo{display:flex;align-items:center;gap:6px;color:var(--accent);font-weight:700;font-size:13px;font-family:var(--font-mono)}
.header-logo svg.ic{font-size:18px}
.header-spacer{flex:1}
.header-btn{background:none;border:1px solid var(--border);color:var(--muted);border-radius:6px;padding:4px 10px;font-size:12px;font-family:var(--font-mono);cursor:pointer;display:flex;align-items:center;gap:4px;transition:all .15s}
.header-btn:hover{color:var(--text);border-color:var(--border-light);background:var(--surface-hover)}
.header-btn.active{color:var(--accent);border-color:var(--accent-border)}
.header-btn svg.ic{font-size:14px}
.model-select{background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:6px;padding:4px 8px;font-size:12px;font-family:var(--font-mono);cursor:pointer;min-width:0;flex-shrink:1}
.model-select:focus{outline:none;border-color:var(--accent)}
.upload-menu{display:none;position:absolute;bottom:calc(100% - 8px);left:16px;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:4px;z-index:50;box-shadow:0 4px 12px rgba(0,0,0,.4)}
.upload-menu.active{display:flex;flex-direction:column;gap:2px}
.upload-menu button{display:flex;align-items:center;gap:8px;padding:8px 14px;background:none;border:none;color:var(--text);font-size:13px;font-family:var(--font-mono);cursor:pointer;border-radius:6px;white-space:nowrap}
.upload-menu button:hover{background:var(--surface-hover)}
.upload-menu-icon{display:inline-flex;align-items:center}

/* ── セッションタブバー ── */
.tab-bar{display:flex;align-items:center;gap:0;border-bottom:1px solid var(--border);background:var(--surface);flex-shrink:0;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}
.tab-bar::-webkit-scrollbar{display:none}
.tab{display:flex;align-items:center;gap:6px;padding:6px 12px;font-size:12px;font-family:var(--font-mono);color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;white-space:nowrap;transition:all .1s;min-width:0;max-width:180px;flex-shrink:0}
.tab:hover{color:var(--text);background:var(--surface-hover)}
.tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.tab .tab-label{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.tab .tab-streaming{width:6px;height:6px;border-radius:50%;background:var(--accent);animation:pulse 1.2s infinite;flex-shrink:0}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.tab .tab-close{color:var(--muted);cursor:pointer;padding:0 2px;border-radius:3px;transition:all .1s;flex-shrink:0;display:flex;align-items:center}
.tab .tab-close:hover{color:var(--danger);background:var(--danger-bg)}
.tab .tab-close svg.ic{font-size:11px}
.tab-add{display:flex;align-items:center;justify-content:center;padding:6px 10px;color:var(--muted);cursor:pointer;transition:all .1s;flex-shrink:0}
.tab-add:hover{color:var(--accent);background:var(--surface-hover)}
.tab-add svg.ic{font-size:14px}

/* ── メッセージコンテナ ── */
#sessionsContainer{flex:1;overflow:hidden;position:relative;min-height:0}
.messages{position:absolute;inset:0;overflow-y:auto;padding:16px;-webkit-overflow-scrolling:touch;display:none;flex-direction:column;gap:16px}
.messages.active{display:flex}

/* ── ユーザーメッセージ ── */
.msg.user{display:flex;justify-content:flex-end}
.msg.user .bubble{background:var(--user-bg);border:1px solid var(--user-border);border-radius:12px 12px 2px 12px;padding:10px 14px;max-width:85%;white-space:pre-wrap;word-break:break-word;font-size:14px;line-height:1.5;color:var(--text-bright)}

/* ── アシスタントメッセージ ── */
.msg.assistant{display:flex;flex-direction:column;gap:8px}
.msg.assistant .content{color:var(--text);word-break:break-word;font-size:14px;line-height:1.7}

/* ── マークダウン ── */
.msg.assistant .content h1{font-size:20px;font-weight:700;margin:16px 0 8px;color:var(--text-bright)}
.msg.assistant .content h2{font-size:17px;font-weight:700;margin:14px 0 6px;color:var(--text-bright)}
.msg.assistant .content h3{font-size:15px;font-weight:700;margin:12px 0 4px;color:var(--text-bright)}
.msg.assistant .content p{margin:6px 0}
.msg.assistant .content ul,.msg.assistant .content ol{padding-left:20px;margin:6px 0}
.msg.assistant .content li{margin:2px 0}
.msg.assistant .content li::marker{color:var(--muted)}
.msg.assistant .content strong{color:var(--text-bright);font-weight:600}
.msg.assistant .content em{color:var(--muted);font-style:italic}
.msg.assistant .content hr{border:none;border-top:1px solid var(--border);margin:12px 0}
.msg.assistant .content a{color:var(--accent);text-decoration:none}
.msg.assistant .content a:hover{text-decoration:underline}

/* ── コードブロック ── */
.msg.assistant .content pre{position:relative;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px 14px;overflow-x:auto;margin:8px 0;font-size:13px;line-height:1.5}
.msg.assistant .content code{font-family:var(--font-mono);font-size:13px}
.msg.assistant .content p code,
.msg.assistant .content li code{background:rgba(192,132,252,.12);color:var(--accent);padding:2px 6px;border-radius:4px;font-size:12px}
.msg.assistant .content pre code{background:none;padding:0;border-radius:0;font-size:13px;color:var(--text)}
.code-copy-btn{position:absolute;top:8px;right:8px;background:var(--surface);color:var(--muted);border:1px solid var(--border);border-radius:4px;padding:2px 8px;font-size:11px;font-family:var(--font-mono);cursor:pointer;opacity:0;transition:opacity .15s}
pre:hover .code-copy-btn{opacity:1}
.code-copy-btn:hover{color:var(--accent);border-color:var(--accent-border)}
.code-copy-btn.copied{color:var(--success);border-color:var(--success)}

/* ── テーブル ── */
.msg.assistant .content table{border-collapse:collapse;width:100%;margin:8px 0;font-size:13px;font-family:var(--font-mono)}
.msg.assistant .content th{background:var(--surface);color:var(--text-bright);font-weight:600;text-align:left;padding:6px 10px;border:1px solid var(--border)}
.msg.assistant .content td{padding:6px 10px;border:1px solid var(--border)}
.msg.assistant .content tr:nth-child(even) td{background:var(--surface)}

/* ── 引用 ── */
.msg.assistant .content blockquote{border-left:3px solid var(--accent);padding:4px 12px;margin:8px 0;color:var(--muted);background:var(--accent-dim);border-radius:0 6px 6px 0}

/* ── ツール実行パネル ── */
.tool-detail{margin:4px 0;border:1px solid var(--border);border-radius:8px;overflow:hidden;font-family:var(--font-mono);font-size:12px;background:var(--surface)}
.tool-detail-header{display:flex;align-items:center;gap:8px;padding:8px 12px;cursor:pointer;user-select:none;transition:background .1s}
.tool-detail-header:hover{background:var(--surface-hover)}
.tool-detail-header .tool-chevron{color:var(--muted);transition:transform .15s;width:12px;display:flex;align-items:center}
.tool-detail-header .tool-chevron svg.ic{font-size:10px}
.tool-detail-header .tool-chevron.open{transform:rotate(90deg)}
.tool-detail-header .tool-icon-label{display:flex;align-items:center;gap:6px}
.tool-detail-header .tool-icon{color:var(--muted);display:flex;align-items:center}
.tool-detail-header .tool-icon svg.ic{font-size:13px}
.tool-detail-header .tool-name{color:var(--accent);font-weight:600;font-size:12px}
.tool-detail-header .tool-file{color:var(--muted);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:11px}
.tool-detail-header .tool-status{color:var(--success);display:flex;align-items:center}
.tool-detail-header .tool-status svg.ic{font-size:12px}
.tool-detail-body{display:none;padding:10px 12px;background:var(--bg);border-top:1px solid var(--border);max-height:300px;overflow:auto;white-space:pre-wrap;word-break:break-all;color:var(--text);line-height:1.4;font-size:12px}
.tool-detail-body.open{display:block}

/* diff */
.diff-line{padding:1px 6px;font-family:var(--font-mono);font-size:12px}
.diff-add{background:var(--diff-add);color:var(--diff-add-text)}
.diff-del{background:var(--diff-del);color:var(--diff-del-text)}
.diff-hunk{color:var(--accent);font-weight:600;margin-top:4px;font-size:11px}

/* ── 警告バッジ ── */
.warning-badge{display:flex;align-items:center;gap:8px;background:var(--warning-bg);color:var(--warning);border:1px solid rgba(249,226,175,.2);border-radius:8px;padding:8px 12px;font-size:12px;margin:4px 0;font-family:var(--font-mono)}
.warning-badge svg.ic{font-size:14px;flex-shrink:0}

/* ── コスト表示 ── */
.meta{font-size:11px;color:var(--muted);margin-top:2px;display:flex;gap:12px;font-family:var(--font-mono)}

/* ── 入力エリア ── */
.input-area{border-top:1px solid var(--border);background:var(--surface);padding:12px 16px;padding-bottom:calc(12px + env(safe-area-inset-bottom));flex-shrink:0;margin-top:auto}
.input-box{border:1px solid var(--border);border-radius:10px;background:var(--bg);overflow:hidden;transition:border-color .15s}
.input-box:focus-within{border-color:var(--accent-border)}
.input-box textarea{width:100%;background:transparent;color:var(--text);border:none;padding:10px 14px;font-size:14px;font-family:var(--font-sans);resize:none;min-height:40px;max-height:150px;line-height:1.4}
.input-box textarea:focus{outline:none}
.input-box textarea::placeholder{color:var(--muted)}
.input-footer{display:flex;align-items:center;gap:6px;padding:4px 8px 6px}
.input-footer button{width:30px;height:30px;border:none;border-radius:6px;background:transparent;color:var(--muted);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .1s}
.input-footer button:hover{background:var(--accent-dim);color:var(--accent)}
.input-footer button:disabled{opacity:.3;cursor:not-allowed}
.input-footer button.send-btn{background:var(--accent);color:#1e1e2e;border-radius:6px}
.input-footer button.send-btn:hover{opacity:.9}
.input-footer button.send-btn:disabled{opacity:.3}
.input-footer button.abort-btn{display:none;background:var(--danger-bg);color:var(--danger)}
.input-footer button.abort-btn:hover{background:rgba(243,139,168,.2)}

/* ── ローディング ── */
.typing{display:flex;align-items:center;gap:6px;padding:8px 0;color:var(--muted);font-size:13px}
.typing-dots{display:flex;gap:3px}
.typing-dots span{width:5px;height:5px;background:var(--accent);border-radius:50%;animation:bounce .6s infinite alternate;opacity:.5}
.typing-dots span:nth-child(2){animation-delay:.2s}
.typing-dots span:nth-child(3){animation-delay:.4s}
@keyframes bounce{to{opacity:.15;transform:translateY(-3px)}}

/* ── ドロワー ── */
.drawer{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:10;display:none;backdrop-filter:blur(2px)}
.drawer.open{display:block}
.drawer-content{position:absolute;bottom:0;left:0;right:0;background:var(--surface);border-radius:14px 14px 0 0;padding:16px;padding-bottom:calc(16px + env(safe-area-inset-bottom));max-height:70vh;overflow-y:auto;border:1px solid var(--border)}

/* ドロワータブ */
.drawer-tabs{display:flex;gap:0;margin-bottom:12px;border-bottom:1px solid var(--border)}
.drawer-tab{padding:8px 14px;font-size:13px;color:var(--muted);cursor:pointer;border:none;background:none;font-family:var(--font-sans);border-bottom:2px solid transparent;font-weight:500;transition:color .1s}
.drawer-tab:hover{color:var(--text)}
.drawer-tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.drawer-tab-content{display:none}
.drawer-tab-content.active{display:block}

/* プロジェクトアイテム */
.project-item{display:flex;flex-direction:column;padding:10px 12px;border:1px solid var(--border);border-radius:8px;margin-bottom:6px;cursor:pointer;transition:all .1s}
.project-item:hover{border-color:var(--border-light);background:var(--surface-hover)}
.project-item.active{border-color:var(--accent-border);background:var(--accent-dim)}
.project-item .name{font-weight:600;font-size:13px;color:var(--text-bright)}
.project-item .path{font-size:11px;color:var(--muted);margin-top:2px;font-family:var(--font-mono)}

/* セッションアイテム */
.session-item{display:flex;flex-direction:column;padding:10px 12px;border:1px solid var(--border);border-radius:8px;margin-bottom:6px;cursor:pointer;transition:all .1s}
.session-item:hover{border-color:var(--border-light);background:var(--surface-hover)}
.session-item.active{border-color:var(--accent-border);background:var(--accent-dim)}
.session-item .preview{font-size:13px;color:var(--text-bright);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.session-item .session-meta{display:flex;gap:8px;font-size:11px;color:var(--muted);margin-top:4px;font-family:var(--font-mono)}
.session-item .delete-session{align-self:flex-end;color:var(--danger);background:none;border:none;font-size:11px;cursor:pointer;padding:2px 6px;font-family:var(--font-mono);opacity:.6;transition:opacity .1s;display:flex;align-items:center;gap:3px}
.session-item .delete-session:hover{opacity:1}

/* ── レスポンシブ ── */
@media(max-width:480px){
  .header{gap:4px;padding:8px 10px}
  .header-logo span{display:none}
  .header-btn{padding:4px 6px;font-size:11px}
  .header-btn .btn-label{display:none}
  .model-select{font-size:11px;padding:3px 4px}
  .tab{padding:4px 8px;font-size:11px;max-width:120px}
  .input-area{padding:8px 10px;padding-bottom:calc(8px + env(safe-area-inset-bottom))}
  .input-footer{gap:3px;padding:3px 6px 4px}
  .input-footer button{width:28px;height:28px}
  .messages{padding:10px}
}
@media(max-width:360px){
  .header-logo svg.ic{font-size:14px}
}

/* ── Plan Mode バナー ── */
.plan-banner{display:none;align-items:center;gap:8px;padding:6px 12px;background:var(--accent-dim);border-bottom:1px solid var(--accent-border);font-size:12px;font-family:var(--font-mono);color:var(--accent);flex-shrink:0}
.plan-banner.active{display:flex}
.plan-banner svg.ic{font-size:13px;flex-shrink:0}
.plan-banner .plan-label{font-weight:600}
.plan-banner .plan-exit{margin-left:auto;background:none;border:1px solid var(--accent-border);color:var(--accent);border-radius:4px;padding:2px 8px;font-size:11px;font-family:var(--font-mono);cursor:pointer}
.plan-banner .plan-exit:hover{background:var(--accent-border)}

/* ── Compacting バナー ── */
.compact-banner{display:none;align-items:center;gap:8px;padding:6px 12px;background:var(--warning-bg);border-bottom:1px solid rgba(249,226,175,.15);font-size:12px;font-family:var(--font-mono);color:var(--warning);flex-shrink:0}
.compact-banner.active{display:flex}
.compact-banner svg.ic{font-size:13px;flex-shrink:0}

/* ── コマンドメニュー ── */
.cmd-menu{display:none;position:absolute;bottom:100%;left:0;right:0;background:var(--surface);border:1px solid var(--border);border-radius:10px 10px 0 0;padding:6px 0;max-height:220px;overflow-y:auto;z-index:5;box-shadow:0 -4px 16px rgba(0,0,0,.3)}
.cmd-menu.open{display:block}
.cmd-item{display:flex;align-items:center;gap:10px;padding:10px 14px;cursor:pointer;transition:background .1s;font-size:13px}
.cmd-item:hover,.cmd-item.focused{background:var(--surface-hover)}
.cmd-item svg.ic{font-size:15px;color:var(--accent);flex-shrink:0}
.cmd-item .cmd-name{color:var(--text-bright);font-weight:600;font-family:var(--font-mono)}
.cmd-item .cmd-desc{color:var(--muted);font-size:12px;margin-left:auto}

/* ── ツール承認UI (モバイル) ── */
.tool-approve{margin:4px 0;border:1px solid var(--warning);border-radius:8px;overflow:hidden;background:var(--warning-bg);font-family:var(--font-mono);font-size:12px}
.tool-approve-header{display:flex;align-items:center;gap:8px;padding:10px 12px;color:var(--warning)}
.tool-approve-header svg.ic{font-size:15px;flex-shrink:0}
.tool-approve-header .tool-approve-name{font-weight:700}
.tool-approve-body{padding:8px 12px;background:var(--bg);border-top:1px solid rgba(249,226,175,.15);font-size:12px;color:var(--text);max-height:150px;overflow:auto;white-space:pre-wrap;word-break:break-all}
.tool-approve-actions{display:flex;gap:8px;padding:8px 12px;border-top:1px solid rgba(249,226,175,.15)}
.tool-approve-actions button{flex:1;padding:8px;border:none;border-radius:6px;font-size:13px;font-family:var(--font-mono);font-weight:600;cursor:pointer}
.tool-approve-actions .btn-allow{background:var(--success);color:#1e1e2e}
.tool-approve-actions .btn-deny{background:var(--danger-bg);color:var(--danger);border:1px solid rgba(243,139,168,.3)}
</style>
</head>
<body>

<div class="header">
  <div class="header-logo" id="headerLogo"></div>
  <div class="header-spacer"></div>
  <button class="header-btn" id="planToggle" onclick="togglePlanMode()" title="Plan Mode"></button>
  <button class="header-btn" id="historyBtn" onclick="openDrawer('sessions')" title="History"></button>
  <button class="header-btn" id="projectsBtn" onclick="openDrawer('projects')" title="Projects"></button>
</div>
<div class="plan-banner" id="planBanner"></div>
<div class="compact-banner" id="compactBanner"></div>

<div class="tab-bar" id="tabBar">
  <div class="tab-add" id="tabAddBtn" onclick="createNewTab()" title="New Chat"></div>
</div>

<div id="sessionsContainer"></div>

<div class="input-area" style="position:relative">
  <div class="cmd-menu" id="cmdMenu"></div>
  <div class="upload-menu" id="uploadMenu">
    <button onclick="doUpload('file')"><span class="upload-menu-icon" id="umFileIcon"></span> File</button>
    <button onclick="doUpload('image')"><span class="upload-menu-icon" id="umImageIcon"></span> Image</button>
  </div>
  <input type="file" id="fileInput" multiple style="display:none">
  <div class="input-box">
    <textarea id="input" rows="1" placeholder="Ask Claude anything..." enterkeyhint="send"></textarea>
    <div class="input-footer">
      <button id="cmdBtn" onclick="toggleCmdMenu()" title="Commands (/)"></button>
      <button id="filesBtn" onclick="showUploadMenu()" title="Upload file"></button>
      <select id="model" class="model-select">
        <option value="default">default (auto)</option>
        <option value="claude-sonnet-4-6" selected>claude-sonnet-4-6</option>
        <option value="claude-opus-4-6">claude-opus-4-6</option>
        <option value="claude-haiku-4-5">claude-haiku-4-5</option>
        <option value="sonnet">sonnet (alias)</option>
        <option value="opus">opus (alias)</option>
        <option value="haiku">haiku (alias)</option>
      </select>
      <span style="flex:1"></span>
      <button class="abort-btn" id="abort" onclick="abortCurrentTab()" title="Stop"></button>
      <button class="send-btn" id="send" onclick="sendMessage()" title="Send (Enter)"></button>
    </div>
  </div>
</div>

<div class="drawer" id="drawer" onclick="closeDrawer()">
  <div class="drawer-content" onclick="event.stopPropagation()">
    <div class="drawer-tabs">
      <button class="drawer-tab active" data-tab="projects" onclick="switchDrawerTab('projects')">Projects</button>
      <button class="drawer-tab" data-tab="sessions" onclick="switchDrawerTab('sessions')">Sessions</button>
    </div>
    <div id="projectsTab" class="drawer-tab-content active">
      <div id="projectList"></div>
    </div>
    <div id="sessionsTab" class="drawer-tab-content">
      <div id="sessionList"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked@15/marked.min.js"></script>
<script>
// ── Lucide インラインSVGアイコン ──
const ICONS = {
  terminal:      '<path d="m4 17 6-6-6-6"/><path d="M12 19h8"/>',
  clock:         '<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>',
  folder:        '<path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"/>',
  plus:          '<path d="M5 12h14"/><path d="M12 5v14"/>',
  x:             '<path d="M18 6 6 18"/><path d="m6 6 12 12"/>',
  square:        '<rect width="18" height="18" x="3" y="3" rx="2"/>',
  'send':        '<path d="M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z"/><path d="m21.854 2.147-10.94 10.939"/>',
  'chevron-right':'<path d="m9 18 6-6-6-6"/>',
  check:         '<path d="M20 6 9 17l-5-5"/>',
  'alert-triangle':'<path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3"/><path d="M12 9v4"/><path d="M12 17h.01"/>',
  'trash-2':     '<path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/>',
  'file-text':   '<path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 13H8"/><path d="M16 17H8"/><path d="M16 13h-2"/>',
  'file-pen':    '<path d="M12.5 22H18a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2v9.5"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M13.378 15.626a1 1 0 1 0-3.004-3.004l-5.01 5.012a2 2 0 0 0-.506.854l-.837 2.87a.5.5 0 0 0 .62.62l2.87-.837a2 2 0 0 0 .854-.506z"/>',
  search:        '<circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/>',
  globe:         '<circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/>',
  bot:           '<path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/>',
  'list-checks': '<path d="m3 17 2 2 4-4"/><path d="m3 7 2 2 4-4"/><path d="M13 6h8"/><path d="M13 12h8"/><path d="M13 18h8"/>',
  wrench:        '<path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76Z"/>',
  slash:         '<path d="M22 2 2 22"/>',
  'map-pin':     '<path d="M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0"/><circle cx="12" cy="10" r="3"/>',
  'layout-list': '<rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/><path d="M14 4h7"/><path d="M14 9h7"/><path d="M14 15h7"/><path d="M14 20h7"/>',
  'shield':      '<path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"/>',
  'zap':         '<path d="M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z"/>',
  'link':        '<path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>',
  'eraser':      '<path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21"/><path d="M22 21H7"/><path d="m5 11 9 9"/>',
  'upload':      '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/>',
  'image':       '<rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>',
}

function ic(name, size) {
  const s = size ? `style="font-size:${size}px"` : ''
  return `<svg class="ic" viewBox="0 0 24 24" ${s}>${ICONS[name] || ''}</svg>`
}

// ツールアイコンマップ
const TOOL_ICON_MAP = {
  Read: 'file-text', Write: 'file-pen', Edit: 'file-pen', Bash: 'terminal',
  Glob: 'search', Grep: 'search', WebFetch: 'globe', WebSearch: 'globe',
  Task: 'bot', TodoWrite: 'list-checks', NotebookEdit: 'file-pen',
}

// --- ヘッダー等にアイコンを注入 ---
document.getElementById('headerLogo').innerHTML = ic('terminal', 18) + '<span id="title">claude-crew</span>'
document.getElementById('planToggle').innerHTML = ic('map-pin', 14) + '<span class="btn-label"> Plan</span>'
document.getElementById('historyBtn').innerHTML = ic('clock', 14) + '<span class="btn-label"> History</span>'
document.getElementById('projectsBtn').innerHTML = ic('folder', 14)
document.getElementById('tabAddBtn').innerHTML = ic('plus', 14)
document.getElementById('cmdBtn').innerHTML = ic('slash', 14)
document.getElementById('filesBtn').innerHTML = ic('upload', 14)
document.getElementById('umFileIcon').innerHTML = ic('file-text', 14)
document.getElementById('umImageIcon').innerHTML = ic('image', 14)
document.getElementById('abort').innerHTML = ic('square', 14)
document.getElementById('send').innerHTML = ic('send', 14)

// --- State ---
let currentProject = null
const sendBtn = document.getElementById('send')
const abortBtn = document.getElementById('abort')
const inputEl = document.getElementById('input')
const tabBar = document.getElementById('tabBar')
const sessionsContainer = document.getElementById('sessionsContainer')

// マルチセッション管理
let activeTabId = null
const tabs = new Map()

function genTabId() { return 'tab-' + Date.now() + '-' + Math.random().toString(36).slice(2,6) }

// --- marked カスタムレンダラー ---
const renderer = new marked.Renderer()
renderer.code = function({ text, lang }) {
  const langLabel = lang ? esc(lang) : ''
  const escaped = esc(text)
  return `<pre><button class="code-copy-btn" onclick="copyCode(this)" data-testid="code-copy-btn">Copy</button><code class="language-${langLabel}">${escaped}</code></pre>`
}
marked.setOptions({ renderer, breaks: true })

// --- コードコピー ---
function copyCode(btn) {
  const code = btn.parentElement.querySelector('code')
  const text = code.textContent
  navigator.clipboard.writeText(text).then(() => {
    btn.textContent = 'Copied!'
    btn.classList.add('copied')
    setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied') }, 1500)
  }).catch(() => {
    const ta = document.createElement('textarea')
    ta.value = text
    document.body.appendChild(ta)
    ta.select()
    document.execCommand('copy')
    document.body.removeChild(ta)
    btn.textContent = 'Copied!'
    btn.classList.add('copied')
    setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied') }, 1500)
  })
}

// --- モデル選択（ヘッダーのselectのみで管理） ---

// --- Plan Mode ---
let planMode = false
function togglePlanMode() {
  planMode = !planMode
  const btn = document.getElementById('planToggle')
  const banner = document.getElementById('planBanner')
  btn.classList.toggle('active', planMode)
  banner.classList.toggle('active', planMode)
  banner.innerHTML = planMode
    ? `${ic('map-pin', 13)} <span class="plan-label">Plan Mode</span> <span>Claude will plan before acting</span> <button class="plan-exit" onclick="togglePlanMode()">Exit</button>`
    : ''
}

// --- Compacting 表示 ---
function showCompacting(show) {
  const banner = document.getElementById('compactBanner')
  banner.classList.toggle('active', show)
  banner.innerHTML = show
    ? `${ic('zap', 13)} <span>Compacting context...</span>`
    : ''
}
function showCompactDone(trigger, preTokens) {
  const banner = document.getElementById('compactBanner')
  banner.classList.add('active')
  const info = preTokens ? ` (${Math.round(preTokens/1000)}k tokens compacted)` : ''
  banner.innerHTML = `${ic('zap', 13)} <span>Context compacted${info}</span>`
  setTimeout(() => { banner.classList.remove('active') }, 4000)
}

// --- コマンドメニュー ---
const CMD_ITEMS = [
  { name: '/plan', desc: 'Toggle plan mode', icon: 'map-pin', action: () => togglePlanMode() },
  { name: '/compact', desc: 'Compact context', icon: 'zap', action: () => { inputEl.value = '/compact'; sendMessage() } },
  { name: '/clear', desc: 'Clear chat', icon: 'eraser', action: () => clearCurrentTab() },
]
let cmdMenuOpen = false
function toggleCmdMenu() {
  cmdMenuOpen = !cmdMenuOpen
  const menu = document.getElementById('cmdMenu')
  menu.classList.toggle('open', cmdMenuOpen)
  if (cmdMenuOpen) renderCmdMenu()
}
function closeCmdMenu() {
  cmdMenuOpen = false
  document.getElementById('cmdMenu').classList.remove('open')
}
function renderCmdMenu() {
  const menu = document.getElementById('cmdMenu')
  menu.innerHTML = CMD_ITEMS.map((c, i) =>
    `<div class="cmd-item" onclick="execCmd(${i})">${ic(c.icon, 15)} <span class="cmd-name">${c.name}</span> <span class="cmd-desc">${c.desc}</span></div>`
  ).join('')
}
function execCmd(idx) {
  closeCmdMenu()
  CMD_ITEMS[idx].action()
}
function clearCurrentTab() {
  const tab = tabs.get(activeTabId)
  if (!tab) return
  tab.messagesEl.innerHTML = ''
  tab.fullTexts = new WeakMap()
  tab.sessionId = null
  tab.label = 'New Chat'
  renderTabs()
}

// --- File Upload ---
const uploadMenu = document.getElementById('uploadMenu')
const fileInput = document.getElementById('fileInput')

function showUploadMenu() {
  uploadMenu.classList.toggle('active')
}
function doUpload(mode) {
  uploadMenu.classList.remove('active')
  if (mode === 'image') {
    fileInput.accept = 'image/*'
  } else {
    fileInput.accept = 'text/*,.ts,.tsx,.js,.jsx,.json,.md,.yaml,.yml,.toml,.css,.html,.py,.sh,.sql,.xml,.csv,.log,.env,.gitignore'
  }
  fileInput.click()
}
document.addEventListener('click', (e) => {
  if (!uploadMenu.contains(e.target) && e.target !== document.getElementById('filesBtn') && !document.getElementById('filesBtn').contains(e.target)) {
    uploadMenu.classList.remove('active')
  }
})
fileInput.addEventListener('change', async (e) => {
  const files = e.target.files
  if (!files || files.length === 0) return
  const isImage = fileInput.accept.startsWith('image')
  if (isImage) {
    const parts = []
    for (const file of files) {
      try {
        const reader = new FileReader()
        const dataUrl = await new Promise((resolve, reject) => {
          reader.onload = () => resolve(reader.result)
          reader.onerror = reject
          reader.readAsDataURL(file)
        })
        parts.push(`[image: ${file.name}]\n${dataUrl}`)
      } catch { parts.push(`[image: ${file.name}] (読み込みエラー)`) }
    }
    const sep = inputEl.value ? '\n' : ''
    inputEl.value += sep + parts.join('\n\n')
  } else {
    const parts = []
    for (const file of files) {
      try {
        const text = await file.text()
        parts.push(`--- ${file.name} ---\n${text}`)
      } catch { parts.push(`--- ${file.name} --- (読み込みエラー)`) }
    }
    const sep = inputEl.value ? '\n' : ''
    inputEl.value += sep + parts.join('\n\n')
  }
  inputEl.style.height = 'auto'
  inputEl.style.height = Math.min(inputEl.scrollHeight, 200) + 'px'
  inputEl.focus()
  e.target.value = ''
})

// --- タブ管理 ---
function createNewTab(label) {
  const tabId = genTabId()
  const messagesEl = document.createElement('div')
  messagesEl.className = 'messages'
  messagesEl.id = 'msgs-' + tabId
  sessionsContainer.appendChild(messagesEl)

  tabs.set(tabId, {
    sessionId: null,
    streamId: null,
    sending: false,
    messagesEl,
    fullTexts: new WeakMap(),
    label: label || 'New Chat',
  })

  renderTabs()
  switchTab(tabId)
  return tabId
}

function switchTab(tabId) {
  if (!tabs.has(tabId)) return
  activeTabId = tabId
  tabs.forEach((t, id) => {
    t.messagesEl.classList.toggle('active', id === tabId)
  })
  renderTabs()
  const tab = tabs.get(tabId)
  updateStreamingUI(tab.sending)
  inputEl.focus()
}

function closeTab(tabId) {
  const tab = tabs.get(tabId)
  if (!tab) return
  if (tab.sending && tab.streamId) {
    fetch('/api/chat/abort', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ streamId: tab.streamId }),
    }).catch(() => {})
  }
  tab.messagesEl.remove()
  tabs.delete(tabId)
  if (activeTabId === tabId) {
    const remaining = Array.from(tabs.keys())
    if (remaining.length > 0) {
      switchTab(remaining[remaining.length - 1])
    } else {
      createNewTab()
    }
  } else {
    renderTabs()
  }
}

function renderTabs() {
  const addBtn = tabBar.querySelector('.tab-add')
  tabBar.querySelectorAll('.tab').forEach(t => t.remove())

  tabs.forEach((tab, tabId) => {
    const el = document.createElement('div')
    el.className = 'tab' + (tabId === activeTabId ? ' active' : '')
    el.onclick = (e) => { if (!e.target.closest('.tab-close')) switchTab(tabId) }

    let inner = ''
    if (tab.sending) inner += '<span class="tab-streaming"></span>'
    inner += `<span class="tab-label">${esc(tab.label)}</span>`
    if (tabs.size > 1) inner += `<span class="tab-close" onclick="closeTab('${tabId}')">${ic('x', 11)}</span>`
    el.innerHTML = inner
    tabBar.insertBefore(el, addBtn)
  })
}

function updateTabLabel(tabId, label) {
  const tab = tabs.get(tabId)
  if (tab) {
    tab.label = label.slice(0, 30) || 'New Chat'
    renderTabs()
  }
}

// --- ストリーミングUI ---
function updateStreamingUI(streaming) {
  sendBtn.disabled = streaming
  sendBtn.style.display = streaming ? 'none' : 'flex'
  abortBtn.style.display = streaming ? 'flex' : 'none'
}

function abortCurrentTab() {
  const tab = tabs.get(activeTabId)
  if (!tab || !tab.streamId) return
  fetch('/api/chat/abort', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    body: JSON.stringify({ streamId: tab.streamId }),
  }).catch(e => console.error('Abort failed:', e))
}

// --- 初期化 ---
async function init() {
  try {
    const res = await fetch('/api/projects', { credentials: 'include' })
    const projects = await res.json()
    renderProjectList(projects)
    if (!currentProject && projects.length > 0) selectProject(projects[0])
  } catch (e) {
    console.error('Failed to load projects:', e)
  }
  createNewTab()
}

function renderProjectList(projects) {
  const list = document.getElementById('projectList')
  list.innerHTML = ''
  projects.forEach(p => {
    const el = document.createElement('div')
    el.className = 'project-item' + (currentProject === p.localPath ? ' active' : '')
    el.innerHTML = `<span class="name">${esc(p.slug)}</span><span class="path">${esc(p.localPath)}</span>`
    el.onclick = () => { selectProject(p); closeDrawer() }
    list.appendChild(el)
  })
}

function selectProject(p) {
  currentProject = p.localPath
  document.getElementById('title').textContent = p.slug
}

// --- ドロワー ---
function openDrawer(tab) {
  document.getElementById('drawer').classList.add('open')
  if (tab) switchDrawerTab(tab)
  if (tab === 'sessions') loadSessions()
}
function closeDrawer() { document.getElementById('drawer').classList.remove('open') }

function switchDrawerTab(tab) {
  document.querySelectorAll('.drawer-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab))
  document.getElementById('projectsTab').classList.toggle('active', tab === 'projects')
  document.getElementById('sessionsTab').classList.toggle('active', tab === 'sessions')
}

// --- セッション履歴 ---
async function loadSessions() {
  try {
    const res = await fetch('/api/chat/sessions', { credentials: 'include' })
    const sessions = await res.json()
    renderSessionList(sessions)
  } catch (e) {
    console.error('Failed to load sessions:', e)
  }
}

function renderSessionList(list) {
  const container = document.getElementById('sessionList')
  if (list.length === 0) {
    container.innerHTML = '<div style="color:var(--muted);font-size:13px;padding:16px;text-align:center">No sessions yet</div>'
    return
  }
  container.innerHTML = ''
  list.forEach(s => {
    const el = document.createElement('div')
    // 既にタブで開いているか判定
    const openTabId = findTabBySessionId(s.sessionId)
    el.className = 'session-item' + (openTabId ? ' active' : '')
    el.setAttribute('data-testid', 'session-item')
    const timeStr = new Date(s.lastUsed).toLocaleString('ja-JP', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' })
    const statusLabel = openTabId ? '<span style="color:var(--accent);font-size:10px">OPEN</span>' : ''
    el.innerHTML = `
      <span class="preview">${esc(s.messagePreview || s.sessionId)} ${statusLabel}</span>
      <div class="session-meta">
        <span>${esc(s.model || '')}</span>
        <span>${timeStr}</span>
      </div>
      <button class="delete-session" onclick="event.stopPropagation();deleteSession('${esc(s.id || s.sessionId.slice(0,12))}')">${ic('trash-2', 11)} delete</button>
    `
    el.onclick = () => { resumeSession(s); closeDrawer() }
    container.appendChild(el)
  })
}

function findTabBySessionId(sessionId) {
  for (const [tabId, tab] of tabs) {
    if (tab.sessionId === sessionId) return tabId
  }
  return null
}

function resumeSession(s) {
  // 既にタブで開いているならそのタブに切り替え
  const existingTabId = findTabBySessionId(s.sessionId)
  if (existingTabId) {
    switchTab(existingTabId)
    return
  }
  // 新しいタブで開く
  const tabId = createNewTab(s.messagePreview || s.sessionId.slice(0, 12))
  const tab = tabs.get(tabId)
  tab.sessionId = s.sessionId
  addMessage(tabId, 'user', `(Resumed: ${s.messagePreview || s.sessionId.slice(0,12)})`)
}

async function deleteSession(id) {
  try {
    await fetch(`/api/chat/sessions/${id}`, { method: 'DELETE', credentials: 'include' })
    loadSessions()
  } catch (e) {
    console.error('Failed to delete session:', e)
  }
}

// --- メッセージ送信 ---
async function sendMessage() {
  const text = inputEl.value.trim()
  if (!text) return
  if (!activeTabId || !tabs.has(activeTabId)) return

  const tab = tabs.get(activeTabId)
  if (tab.sending) return

  tab.sending = true
  updateStreamingUI(true)
  renderTabs()
  inputEl.value = ''
  autoResize()

  if (tab.label === 'New Chat') {
    updateTabLabel(activeTabId, text)
  }

  const tabId = activeTabId
  addMessage(tabId, 'user', text)
  const assistantEl = addMessage(tabId, 'assistant', '')
  const content = assistantEl.querySelector('.content')
  content.innerHTML = '<div class="typing"><div class="typing-dots"><span></span><span></span><span></span></div></div>'

  try {
    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({
        message: text,
        project: currentProject,
        sessionId: tab.sessionId,
        model: document.getElementById('model').value,
        planMode,
      }),
    })

    const reader = res.body.getReader()
    const decoder = new TextDecoder()
    let buffer = ''

    while (true) {
      const { done, value } = await reader.read()
      if (done) break
      buffer += decoder.decode(value, { stream: true })

      const blocks = buffer.split('\n\n')
      buffer = blocks.pop() || ''

      for (const block of blocks) {
        if (!block.trim()) continue
        let eventName = 'message'
        const dataLines = []
        for (const line of block.split('\n')) {
          if (line.startsWith('event:')) eventName = line.slice(6).trim()
          else if (line.startsWith('data:')) {
            dataLines.push(line.charAt(5) === ' ' ? line.slice(6) : line.slice(5))
          }
        }
        const data = dataLines.join('\n')
        if (data) handleSSE(tabId, eventName, data, content, assistantEl)
      }
    }
  } catch (e) {
    content.innerHTML = `<span style="color:var(--danger)" data-testid="error-message">Error: ${esc(e.message)}</span>`
  }

  tab.sending = false
  tab.streamId = null
  if (activeTabId === tabId) updateStreamingUI(false)
  renderTabs()
  scrollToBottom(tabId)
}

function handleSSE(tabId, event, data, content, msgEl) {
  const tab = tabs.get(tabId)
  if (!tab) return

  if (event === 'text') {
    const typing = content.querySelector('.typing')
    if (typing) typing.remove()

    if (!tab.fullTexts.has(content)) tab.fullTexts.set(content, '')
    tab.fullTexts.set(content, tab.fullTexts.get(content) + data)
    const preserved = content.querySelectorAll('.tool-detail, .warning-badge')
    const preservedHTML = Array.from(preserved).map(el => el.outerHTML).join('')
    content.innerHTML = preservedHTML + marked.parse(tab.fullTexts.get(content))
    scrollToBottom(tabId)
  }

  if (event === 'tool') {
    try {
      const info = JSON.parse(data)
      if (info.status === 'input' && info.detail) {
        const panel = createToolDetailPanel(info.detail)
        const firstText = content.querySelector('p, h1, h2, h3, ul, ol, pre, blockquote, table')
        if (firstText) firstText.before(panel)
        else content.prepend(panel)
        scrollToBottom(tabId)
      }
      if (info.status === 'output' && info.detail) {
        const panels = content.querySelectorAll('.tool-detail')
        for (let i = panels.length - 1; i >= 0; i--) {
          const nameEl = panels[i].querySelector('.tool-name')
          if (nameEl && nameEl.textContent === info.detail.name) {
            appendToolOutput(panels[i], info.detail.output || '')
            break
          }
        }
        scrollToBottom(tabId)
      }
    } catch {}
  }

  if (event === 'warning') {
    try {
      const w = JSON.parse(data)
      const warn = document.createElement('div')
      warn.className = 'warning-badge'
      warn.setAttribute('data-testid', 'warning-badge')
      warn.innerHTML = `${ic('alert-triangle', 14)} <strong>${esc(w.label)}</strong> ${esc(w.command)}`
      content.appendChild(warn)
      scrollToBottom(tabId)
    } catch {}
  }

  if (event === 'session') {
    try {
      const s = JSON.parse(data)
      if (s.sessionId) tab.sessionId = s.sessionId
      if (s.streamId) tab.streamId = s.streamId
    } catch {}
  }

  if (event === 'result') {
    try {
      const r = JSON.parse(data)
      if (r.sessionId) tab.sessionId = r.sessionId
      if (r.text && !tab.fullTexts.has(content)) {
        content.innerHTML = marked.parse(r.text)
      }
      if (r.cost || r.durationMs) {
        const meta = document.createElement('div')
        meta.className = 'meta'
        meta.setAttribute('data-testid', 'result-meta')
        if (r.cost) meta.innerHTML += `<span>$${r.cost.toFixed(4)}</span>`
        if (r.durationMs) meta.innerHTML += `<span>${(r.durationMs / 1000).toFixed(1)}s</span>`
        if (r.turns) meta.innerHTML += `<span>${r.turns} turns</span>`
        msgEl.appendChild(meta)
      }
    } catch {}
  }

  if (event === 'error') {
    try {
      const e = JSON.parse(data)
      content.innerHTML = `<span style="color:var(--danger)" data-testid="error-message">Error: ${esc(e.message)}</span>`
    } catch {}
  }

  if (event === 'status') {
    try {
      const s = JSON.parse(data)
      if (s.status === 'compacting') showCompacting(true)
      if (s.permissionMode) {
        planMode = s.permissionMode === 'plan'
        document.getElementById('planToggle').classList.toggle('active', planMode)
        document.getElementById('planBanner').classList.toggle('active', planMode)
      }
    } catch {}
  }

  if (event === 'compact') {
    try {
      const c = JSON.parse(data)
      showCompacting(false)
      showCompactDone(c.trigger, c.preTokens)
    } catch {}
  }
}

// --- ツール詳細パネル ---
function createToolDetailPanel(detail) {
  const panel = document.createElement('div')
  panel.className = 'tool-detail'
  panel.setAttribute('data-testid', 'tool-detail')

  const summary = getToolSummary(detail)
  const iconName = TOOL_ICON_MAP[detail.name] || 'wrench'

  panel.innerHTML = `
    <div class="tool-detail-header" onclick="toggleToolDetail(this)">
      <span class="tool-chevron">${ic('chevron-right', 10)}</span>
      <div class="tool-icon-label">
        <span class="tool-icon">${ic(iconName, 13)}</span>
        <span class="tool-name">${esc(detail.name)}</span>
      </div>
      <span class="tool-file">${esc(summary)}</span>
      <span class="tool-status">${ic('check', 12)}</span>
    </div>
    <div class="tool-detail-body">${formatToolInput(detail)}</div>
  `
  return panel
}

function getToolSummary(detail) {
  if (!detail.input) return ''
  const inp = detail.input
  if (detail.name === 'Read') return inp.file_path || ''
  if (detail.name === 'Write') return inp.file_path || ''
  if (detail.name === 'Edit') return inp.file_path || ''
  if (detail.name === 'Bash') return (inp.command || '').slice(0, 80)
  if (detail.name === 'Glob') return inp.pattern || ''
  if (detail.name === 'Grep') return inp.pattern || ''
  return JSON.stringify(inp).slice(0, 80)
}

function formatToolInput(detail) {
  if (!detail.input) return ''
  const inp = detail.input

  if (detail.name === 'Edit' && inp.old_string !== undefined && inp.new_string !== undefined) {
    return formatDiff(inp.old_string || '', inp.new_string || '', inp.file_path || '')
  }
  if (detail.name === 'Bash') {
    return `<div style="color:var(--accent)">$ ${esc(inp.command || '')}</div>`
  }
  if (detail.name === 'Write') {
    const content = inp.content || ''
    return `<div class="diff-add" style="max-height:200px;overflow:auto;padding:4px 6px">${esc(content)}</div>`
  }
  return `<div>${esc(JSON.stringify(inp, null, 2))}</div>`
}

function formatDiff(oldStr, newStr, filePath) {
  const oldLines = oldStr.split('\n')
  const newLines = newStr.split('\n')
  let html = ''
  if (filePath) html += `<div class="diff-hunk">--- ${esc(filePath)}</div>`
  oldLines.forEach(l => { html += `<div class="diff-line diff-del">- ${esc(l)}</div>` })
  newLines.forEach(l => { html += `<div class="diff-line diff-add">+ ${esc(l)}</div>` })
  return html
}

function appendToolOutput(panel, output) {
  const body = panel.querySelector('.tool-detail-body')
  if (!body) return
  if (output) {
    body.innerHTML += `<div style="margin-top:6px;border-top:1px solid var(--border);padding-top:6px;color:var(--muted)">${esc(output)}</div>`
  }
}

function toggleToolDetail(header) {
  const icon = header.querySelector('.tool-chevron')
  const body = header.nextElementSibling
  icon.classList.toggle('open')
  body.classList.toggle('open')
}

// --- UI helpers ---
function addMessage(tabId, role, text) {
  const tab = tabs.get(tabId)
  if (!tab) return
  const el = document.createElement('div')
  el.className = `msg ${role}`
  el.setAttribute('data-testid', `msg-${role}`)
  if (role === 'user') {
    el.innerHTML = `<div class="bubble">${esc(text)}</div>`
  } else {
    el.innerHTML = `<div class="content">${text}</div>`
  }
  tab.messagesEl.appendChild(el)
  scrollToBottom(tabId)
  return el
}

function scrollToBottom(tabId) {
  const tab = tabs.get(tabId || activeTabId)
  if (tab) requestAnimationFrame(() => tab.messagesEl.scrollTop = tab.messagesEl.scrollHeight)
}

function esc(s) {
  if (typeof s !== 'string') s = String(s || '')
  const d = document.createElement('div')
  d.textContent = s
  return d.innerHTML
}

function autoResize() {
  inputEl.style.height = 'auto'
  inputEl.style.height = Math.min(inputEl.scrollHeight, 150) + 'px'
}
inputEl.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey && !e.isComposing) {
    e.preventDefault()
    closeCmdMenu()
    sendMessage()
  }
  if (e.key === 'Escape') closeCmdMenu()
})

// `/` in empty input opens command menu
inputEl.addEventListener('input', () => {
  autoResize()
  if (inputEl.value === '/') toggleCmdMenu()
  else closeCmdMenu()
})

init()
</script>
</body>
</html>
